<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="the-graph">
  <template>
    <style include="iron-flex iron-flex-alignment">

    </style>
    <style>
      :host {
        display: block;
        height: 100%;
      }

      #container {
        padding: 10px;
        height: 100%;
        width: 100%;
        height: 700px;
      }

      paper-tabs {
        background: var(--primary-color);
        width: 100%;
        color: white;
      }
    </style>

    <div class="vertical layout">
      <paper-tabs scrollable id="menu">
        <template is="dom-repeat" items="{{nodes}}" index-as="index">
          <paper-tab on-click="_nodeListClick">{{item.data.label}}
            <paper-icon-button icon="delete"></paper-icon-button>
          </paper-tab>
        </template>
      </paper-tabs>
      <div id="container">

      </div>
    </div>
  </template>
  <script src="../../bower_components/cytoscape/dist/cytoscape.min.js" charset="utf-8"></script>
  <script src="http://46.101.2.83:5000/socket.io/socket.io.js" charset="utf-8"></script>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'the-graph',

        properties: {
          cy: {
            type: Object
          },
          nodes: {
            type: Object,
            value: function() {
              return [];
            }
          },
          edges: {
            type: Object,
            value: function() {
              return [];
            }
          },
          selectedNodes: {
            type: Object,
            value: function() {
              return [];
            }
          },
          selectedEdge: {
            type: Object
          },
          socket: {
            type: Object
          },
          dragInterval: {
            type: Object
          },
          draggedNode: {
            type: Object
          }
        },
        _nodeClick: function(e) {
          var node = e.cyTarget;
          if (this.selectedNodes.indexOf(node) == -1) {
            this.selectedNodes.push(node);
            node.addClass('selected');
            if (this.selectedNodes.length === 2) {
              this.fire('request-add-edge', {
                source: this.selectedNodes[0].id(),
                target: this.selectedNodes[1].id()
              });
              this.reset();
            }
          } else {
            this.selectedNodes.splice(this.selectedNodes.indexOf(node), 1);
            node.removeClass('selected');
          }
        },
        _edgeClick: function(e) {
          var edge = e.cyTarget;
          if (this.selectedEdge == edge) {
            this.removeEdge(edge.id());
            this.selectedEdge = null;
          } else {
            this.selectedEdge = edge;
          }
        },
        _nodeListClick: function(e) {
          var target = e.target;
          while (target.nodeName != 'PAPER-TAB' && target.nodeName != 'PAPER-ICON-BUTTON' && target.nodeName != 'HTML') {
            target = target.parentNode;
          }

          if (target.nodeName == 'PAPER-ICON-BUTTON') {
            var node = this.nodes[e.model.index];
            this.removeNode(node.data.id);
          } else {
            this.goToNode(this.nodes[this.$.menu.selected].data.id);
          }
        },
        _backgroundClick: function(e) {
          var target = e.cyTarget;

          if (target === this.cy) {
            // Click on background
            var position = e.cyPosition;
            this.fire('request-add-node', {
              position: position
            });
          }
        },
        _graphChanged: function(e) {
          this.cy.json(e);
          this.nodes = e.elements.nodes;
          this.edges = e.elements.edges;
        },
        _initGraph: function(e) {
          this.cy.json(e);
          if (e) {
            this.nodes = e.elements.nodes;
            this.edges = e.elements.edges;
          }
        },
        _deleteNodeClick: function(e) {
          e.preventDefault();
          var node = this.nodes[e.model.index];
          // this.removeNode(node.data.id);
          // this.center();
        },
        _nodeDrag: function(e) {
          if (this.dragInterval) {
            clearInterval(this.dragInterval);
            this.dragInterval = null;
          }
          this.dragInterval = setInterval(function() {
            e.cyTarget.json({selected: false})
            this.nodes = this.cy.json().elements.nodes;
            this.edges = this.cy.json().elements.edges;
            this.socketEmit('change-graph', this.cy.json());

            clearInterval(this.dragInterval);
          }.bind(this), 500);
        },
        ready: function() {
          // Initialise graph
          this.cy = cytoscape({
            container: this.$.container,
            style: [{
              selector: 'node',
              style: {
                'background-color': 'data(color)',
                'label': 'data(label)'
              }
            }, {
              selector: ':parent',
              style: {
                'background-opacity': 0.333
              }
            }, {
              selector: 'edge',
              style: {
                'width': 3,
                'line-color': 'data(color)'
              }
            }, {
              selector: '.selected',
              style: {
                'border-width': '5px',
                'border-color': 'black'
              }
            }]
          });

          window.graph = this;

          //Graph event
          this.cy.on('tap', 'node', this._nodeClick.bind(this));
          this.cy.on('tap', 'edge', this._edgeClick.bind(this));
          this.cy.on('cxttap', this._backgroundClick.bind(this));
          this.cy.on('drag', 'node', this._nodeDrag.bind(this))

          // Initialise socket
          if (io) {
            this.socket = io('https://polycapa.me:3000');
            this.socket.on('graph-changed', this._graphChanged.bind(this));
            this.socket.on('connected', this._initGraph.bind(this));
            this.socket.on('user-number', function(number) {
              this.fire('user-number', {
                number: number
              });
            }.bind(this));
          }
        },
        addNode: function(x, y, label, color, emit) {
          this.reset();

          label = label || '';

          if (color == '') {
            color = '#ec5148';
          }

          if (emit == null) {
            emit = true;
          }

          var nextId = 0;
          if (this.nodes) {
            var lastNodeId = this.nodes[this.nodes.length - 1].data.id;
            nextId = parseInt(lastNodeId.replace('n', '')) + 1;
          }

          if (label == '') {
            label = 'Node ' + nextId;
          }
          var nodeId = 'n' + nextId;
          var node = {
            id: nodeId,
            x: parseFloat(x),
            y: parseFloat(y),
            label: label,
            color: color
          };

          this.cy.add({
            group: "nodes",
            data: node,
            position: {
              x: node.x,
              y: node.y
            },
            grabbable: true
          })

          this.nodes = this.cy.json().elements.nodes;

          if (emit) {
            this.socketEmit('change-graph', this.cy.json());
          }
        },
        removeNode: function(id, emit) {
          this.reset();

          if (emit == null) {
            emit = true;
          }
          var node = this.cy.$('#' + id);
          this.cy.remove(node);

          this.nodes = this.cy.json().elements.nodes;

          this.edges = this.cy.json().elements.edges;

          if (!this.nodes) {
            this.nodes = [];
          }
          if (!this.edges) {
            this.edges = [];
          }

          if (emit) {
            this.socketEmit('change-graph', this.cy.json());
          }
        },
        addEdge: function(source, target, color, emit) {

          this.reset();
          color = color || '#ad1a66';

          if (emit == null) {
            emit = true;
          }

          var nextId = 0;
          if (this.edges) {
            var lastEdgeId = this.edges[this.edges.length - 1].data.id;
            nextId = parseInt(lastEdgeId.replace('e', '')) + 1;
          }

          var edgeId = 'e' + nextId;
          var edge = {
            id: edgeId,
            source: source,
            target: target,
            color: color
          };

          this.cy.add({
            group: 'edges',
            data: edge
          });

          this.edges = this.cy.json().elements.edges;

          if (emit) {
            this.socketEmit('change-graph', this.cy.json());
          }
        },
        removeEdge: function(id, emit) {
          this.reset();

          if (emit == null) {
            emit = true;
          }
          var edge = this.cy.$('#' + id);
          this.cy.remove(edge);
          this.edges = this.cy.json().elements.edges;

          if (!this.nodes) {
            this.nodes = [];
          }
          if (!this.edges) {
            this.edges = [];
          }

          if (emit) {
            this.socketEmit('change-graph', this.cy.json());
          }
        },
        goToNode: function(id) {
          id = id || 'n0';
          var node = this.cy.$('#' + id);
          this.cy.animate({
            fit: {
              eles: node,
              padding: 280
            }
          });
        },
        center: function() {
          this.cy.animate({
            fit: {
              center: true,
              zoom: 0.6
            }
          });
          this.$.menu.selected = null;
        },
        socketEmit: function(event, data) {
          this.socket.emit(event, data);
        },
        reset: function() {
          for (var i = 0; i < this.selectedNodes.length; i++) {
            this.selectedNodes[i].removeClass('selected');
          }
          this.selectedNodes = [];
          this.selectedEdge = null;
        },
        dijkstra: function (nomSource,nomTarget) {
          var source = this.cy.$("[label='"+nomSource+"']")[0];
          var target = this.cy.$("[label='"+nomTarget+"']")[0];
          var dijkstra = this.cy.elements().dijkstra(source,function () {
            return 1;
          });

          var distanceTo = dijkstra.distanceTo(target);
          var pathTo = dijkstra.pathTo(target);

          var path = 'Distance totale : ' + distanceTo + ' : ';
          for (var i = 0; i < pathTo.length; i++) {
            var data = pathTo[i].data();
            if (data.label) {
              path += ' -> ' + data.label;
            }
          }
          console.log(path);
          return path;
        }
      });
    })();
  </script>
</dom-module>
